.data
val:    .word       512
v1:     .double     1.11, 2.22, 3.33, 4.44, 1.11, 2.22, 3.33, 4.44
        .double     1.11, 2.22, 3.33, 4.44, 1.11, 2.22, 3.33, 4.44
        .double     1.11, 2.22, 3.33, 4.44, 1.11, 2.22, 3.33, 4.44
        .double     1.11, 2.22, 3.33, 4.44, 1.11, 2.22, 3.33, 4.44
        .double     1.11, 2.22, 3.33, 4.44, 1.11, 2.22, 3.33, 4.44
        .double     1.11, 2.22, 3.33, 4.44, 1.11, 2.22, 3.33, 4.44
        .double     1.11, 2.22, 3.33, 4.44, 1.11, 2.22, 3.33, 4.44
        .double     1.11, 2.22, 3.33, 4.44, 1.11, 2.22, 3.33, 4.44

v2:     .double     0.00, 5.55, 0.00, 6.66, 7.77, 0.00, 8.88, 0.00
        .double     0.00, 5.55, 0.00, 6.66, 7.77, 0.00, 8.88, 0.00
        .double     0.00, 5.55, 0.00, 6.66, 7.77, 0.00, 8.88, 0.00
        .double     0.00, 5.55, 0.00, 6.66, 7.77, 0.00, 8.88, 0.00
        .double     0.00, 5.55, 0.00, 6.66, 7.77, 0.00, 8.88, 0.00
        .double     0.00, 5.55, 0.00, 6.66, 7.77, 0.00, 8.88, 0.00
        .double     0.00, 5.55, 0.00, 6.66, 7.77, 0.00, 8.88, 0.00
        .double     0.00, 5.55, 0.00, 6.66, 7.77, 0.00, 8.88, 0.00

v3:     .double     7.77, 0.00, 8.88, 0.00, 0.00, 5.55, 0.00, 6.66
        .double     7.77, 0.00, 8.88, 0.00, 0.00, 5.55, 0.00, 6.66
        .double     7.77, 0.00, 8.88, 0.00, 0.00, 5.55, 0.00, 6.66
        .double     7.77, 0.00, 8.88, 0.00, 0.00, 5.55, 0.00, 6.66
        .double     7.77, 0.00, 8.88, 0.00, 0.00, 5.55, 0.00, 6.66
        .double     7.77, 0.00, 8.88, 0.00, 0.00, 5.55, 0.00, 6.66
        .double     7.77, 0.00, 8.88, 0.00, 0.00, 5.55, 0.00, 6.66
        .double     7.77, 0.00, 8.88, 0.00, 0.00, 5.55, 0.00, 6.66

v4:     .double     9.99,10.10,11.11,12.12, 9.99,10.10,11.11,12.12
        .double     9.99,10.10,11.11,12.12, 9.99,10.10,11.11,12.12
        .double     9.99,10.10,11.11,12.12, 9.99,10.10,11.11,12.12
        .double     9.99,10.10,11.11,12.12, 9.99,10.10,11.11,12.12
        .double     9.99,10.10,11.11,12.12, 9.99,10.10,11.11,12.12
        .double     9.99,10.10,11.11,12.12, 9.99,10.10,11.11,12.12
        .double     9.99,10.10,11.11,12.12, 9.99,10.10,11.11,12.12
        .double     9.99,10.10,11.11,12.12, 9.99,10.10,11.11,12.12

v5:     .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00

v6:     .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00

v7:     .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
        .double     0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00

.text
main:   
    daddi R1, R0, 0                     ; indice vettore
    lw R2, val(R1)                      ; num valori
    daddi R4, R0, 1

loop:
    l.d F1, v1(R1)
    l.d F2, v2(R1)
    l.d F3, v3(R1)
    l.d F4, v4(R1)

    andi R3, R1, 8
    bnez R3, odd                        ; se R3 AND 8 == 0, even | se R3 AND 8 != 0, odd
    dsrl R3, R1, 3                      ; 
even:

    dsllv R4, R4, R3                    ; m = m<<i
    mtc1 R4, F8                         ; int m -> float m
    cvt.d.l F9, F8                      ; float m -> double m

    mul.d F9, F1, F9                    ; p=v1[i]*m
    daddi R5, R0, 1                     ; 
    daddi R3, R3, 1
    dsllv R5, R5, R3                    ; 2^i

    cvt.l.d F9, F9                      ; float m <- double m
    mfc1 R4, F9                         ; int m <- float m

    daddi R5, R0, 1                     ; 
    j continue
    dsllv R5, R5, R3                    ; 2^i

odd:
    dmul R4, R4, R3                     ; m = m*i

    cvt.l.d F5, F4                      ; float v4i <- double v4i
    mfc1 R6, F5                         ; int v4i <- float v4i
    ddiv R6, R6, R5                     ; k=v4[i]/2^i

    mtc1 R4, F8                         ; int m -> float m
    cvt.d.l F9, F8                      ; float m -> double m
    div.d F9, F1, F9                    ; p = v1[i]/m

    mtc1 R6, F10                         ; int k -> float k
    cvt.d.l F10, F10                     ; float k -> double k
    
continue:

    add.d F6, F10, F1
    add.d F7, F2, F3

    mul.d F5, F9, F2
    add.d F5, F5, F3
    add.d F5, F5, F4
    s.d F5, v5(R1)

    div.d F6, F5, F6
    s.d F6, v6(R1)

    mul.d F7, F6, F7
    s.d F7, v7(R1)

    daddi R1, R1, 8
    bne R1, R2, loop

    halt
